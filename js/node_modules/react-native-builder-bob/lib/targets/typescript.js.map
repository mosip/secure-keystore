{"version":3,"file":"typescript.js","names":["build","root","output","report","options","info","kleur","blue","path","relative","del","project","tsconfig","join","fs","pathExists","config","JSON5","parse","readFile","compilerOptions","conflicts","noEmit","undefined","push","emitDeclarationOnly","declarationDir","outDir","length","warn","reduce","acc","curr","gray","yellow","e","Error","tsc","resolve","execpath","process","env","npm_execpath","cli","split","pop","includes","result","spawn","sync","stdio","encoding","cwd","stdout","trim","platform","endsWith","which","tsbuildinfo","replace","status","success","error","toString","message"],"sources":["../../src/targets/typescript.ts"],"sourcesContent":["import kleur from 'kleur';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport which from 'which';\nimport spawn from 'cross-spawn';\nimport del from 'del';\nimport JSON5 from 'json5';\nimport { platform } from 'os';\nimport type { Input } from '../types';\n\ntype Options = Input & {\n  options?: { project?: string; tsc?: string };\n};\n\nexport default async function build({\n  root,\n  output,\n  report,\n  options,\n}: Options) {\n  report.info(\n    `Cleaning up previous build at ${kleur.blue(path.relative(root, output))}`\n  );\n\n  await del([output]);\n\n  report.info(`Generating type definitions with ${kleur.blue('tsc')}`);\n\n  const project = options?.project ? options.project : 'tsconfig.json';\n  const tsconfig = path.join(root, project);\n\n  try {\n    if (await fs.pathExists(tsconfig)) {\n      try {\n        const config = JSON5.parse(await fs.readFile(tsconfig, 'utf-8'));\n\n        if (config.compilerOptions) {\n          const conflicts: string[] = [];\n\n          if (config.compilerOptions.noEmit !== undefined) {\n            conflicts.push('compilerOptions.noEmit');\n          }\n\n          if (config.compilerOptions.emitDeclarationOnly !== undefined) {\n            conflicts.push('compilerOptions.emitDeclarationOnly');\n          }\n\n          if (config.compilerOptions.declarationDir) {\n            conflicts.push('compilerOptions.declarationDir');\n          }\n\n          if (\n            config.compilerOptions.outDir &&\n            path.join(root, config.compilerOptions.outDir) !== output\n          ) {\n            conflicts.push('compilerOptions.outDir');\n          }\n\n          if (conflicts.length) {\n            report.warn(\n              `Found following options in the config file which can conflict with the CLI options. Please remove them from ${kleur.blue(\n                project\n              )}:${conflicts.reduce(\n                (acc, curr) =>\n                  acc + `\\n${kleur.gray('-')} ${kleur.yellow(curr)}`,\n                ''\n              )}`\n            );\n          }\n        }\n      } catch (e) {\n        report.warn(\n          `Couldn't parse '${project}'. There might be validation errors.`\n        );\n      }\n    } else {\n      throw new Error(\n        `Couldn't find a ${kleur.blue('tsconfig.json')} in the project root.`\n      );\n    }\n\n    let tsc;\n\n    if (options?.tsc) {\n      tsc = path.resolve(root, options.tsc);\n\n      if (!(await fs.pathExists(tsc))) {\n        throw new Error(\n          `The ${kleur.blue(\n            'tsc'\n          )} binary doesn't seem to be installed at ${kleur.blue(\n            tsc\n          )}. Please specify the correct path in options or remove it to use the workspace's version.`\n        );\n      }\n    } else {\n      const execpath = process.env.npm_execpath;\n      const cli = execpath?.split('/').pop()?.includes('yarn') ? 'yarn' : 'npm';\n\n      try {\n        if (cli === 'yarn') {\n          const result = spawn.sync('yarn', ['bin', 'tsc'], {\n            stdio: 'pipe',\n            encoding: 'utf-8',\n            cwd: root,\n          });\n\n          tsc = result.stdout.trim();\n        } else {\n          const result = spawn.sync('npm', ['bin'], {\n            stdio: 'pipe',\n            encoding: 'utf-8',\n            cwd: root,\n          });\n\n          tsc = path.resolve(result.stdout.trim(), 'tsc');\n        }\n      } catch (e) {\n        tsc = path.resolve(root, 'node_modules', '.bin', 'tsc');\n      }\n\n      if (platform() === 'win32' && !tsc.endsWith('.cmd')) {\n        tsc += '.cmd';\n      }\n    }\n\n    if (!(await fs.pathExists(tsc))) {\n      try {\n        tsc = await which('tsc');\n\n        if (await fs.pathExists(tsc)) {\n          report.warn(\n            `Failed to locate 'tsc' in the workspace. Falling back to the globally installed version. Consider adding ${kleur.blue(\n              'typescript'\n            )} to your ${kleur.blue(\n              'devDependencies'\n            )} or specifying the ${kleur.blue(\n              'tsc'\n            )} option for the typescript target.`\n          );\n        }\n      } catch (e) {\n        // Ignore\n      }\n    }\n\n    if (tsc == null || !(await fs.pathExists(tsc))) {\n      throw new Error(\n        `The ${kleur.blue(\n          'tsc'\n        )} binary doesn't seem to be installed under ${kleur.blue(\n          'node_modules'\n        )} or present in $PATH. Make sure you have added ${kleur.blue(\n          'typescript'\n        )} to your ${kleur.blue('devDependencies')} or specify the ${kleur.blue(\n          'tsc'\n        )} option for typescript.`\n      );\n    }\n\n    const tsbuildinfo = path.join(\n      output,\n      project.replace(/\\.json$/, '.tsbuildinfo')\n    );\n\n    try {\n      await del([tsbuildinfo]);\n    } catch (e) {\n      // Ignore\n    }\n\n    const result = spawn.sync(\n      tsc,\n      [\n        '--pretty',\n        '--declaration',\n        '--declarationMap',\n        '--emitDeclarationOnly',\n        '--project',\n        project,\n        '--outDir',\n        output,\n      ],\n      {\n        stdio: 'inherit',\n        cwd: root,\n      }\n    );\n\n    if (result.status === 0) {\n      await del([tsbuildinfo]);\n\n      report.success(\n        `Wrote definition files to ${kleur.blue(path.relative(root, output))}`\n      );\n    } else {\n      throw new Error('Failed to build definition files.');\n    }\n  } catch (e: any) {\n    if (e.stdout) {\n      report.error(\n        `Errors found when building definition files:\\n${e.stdout.toString()}`\n      );\n    } else {\n      report.error(e.message);\n    }\n\n    throw new Error('Failed to build definition files.');\n  }\n}\n"],"mappings":"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"}